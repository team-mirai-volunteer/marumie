# Supabaseマイグレーション運用ルール

## 概要

本プロジェクトでは、Supabaseを使用してデータベースを管理し、ローカル開発環境（エミュレーター）、開発環境（develop）、本番環境（production）の3つの環境で運用します。

## 環境構成

### 1. ローカル環境（Local）
- **用途**: 開発者個人の開発・テスト
- **実行方式**: Supabase Local Development（Docker）
- **データベース**: PostgreSQL（ローカルコンテナ）
- **URL**: `http://localhost:54321`
- **データベースURL**: `postgresql://postgres:postgres@localhost:54322/postgres`

### 2. 開発環境（Develop）
- **用途**: 機能開発完了後の統合テスト、ステージング
- **実行方式**: Supabase Cloud
- **ブランチ**: `develop` ブランチと連携
- **自動デプロイ**: develop ブランチへのマージ時

### 3. 本番環境（Production）
- **用途**: 本番サービス
- **実行方式**: Supabase Cloud
- **ブランチ**: `main` ブランチと連携
- **自動デプロイ**: main ブランチへのマージ時

## マイグレーション管理ルール

### 1. マイグレーションファイル作成

```bash
# 新しいマイグレーションファイル作成
supabase migration new [マイグレーション名]

# 例：
supabase migration new create_users_table
supabase migration new add_index_to_transactions
supabase migration new update_political_organizations_schema
```

### 2. マイグレーションファイル命名規則

- **形式**: `YYYYMMDDHHMMSS_[変更内容].sql`
- **例**:
  - `20250816115400_create_users_table.sql`
  - `20250816120000_add_index_to_transactions.sql`
  - `20250816121500_update_political_organizations_schema.sql`

### 3. 環境別実行手順

#### ローカル環境での開発フロー

```bash
# 1. ローカルSupabase起動
supabase start

# 2. マイグレーションファイル作成
supabase migration new [マイグレーション名]

# 3. SQLファイル編集
# supabase/migrations/xxxx_[マイグレーション名].sql を編集

# 4. ローカルでマイグレーション適用
supabase db reset  # 全リセット + 全マイグレーション適用
# または
supabase migration up  # 未適用マイグレーションのみ適用

# 5. 型定義生成
npm run supabase:types

# 6. テスト実行
npm test

# 7. コミット・プッシュ
git add .
git commit -m "feat: [マイグレーション内容]"
git push origin feature/[ブランチ名]
```

#### 開発環境へのデプロイ

```bash
# 1. develop ブランチにマージ
git checkout develop
git merge feature/[ブランチ名]

# 2. 開発環境にログイン
supabase login
supabase link --project-ref [develop-project-ref]

# 3. マイグレーション適用
supabase db push

# 4. 確認
supabase db diff  # 差分確認
```

#### 本番環境へのデプロイ

```bash
# 1. main ブランチにマージ（PR経由）
git checkout main
git merge develop

# 2. 本番環境にログイン
supabase link --project-ref [production-project-ref]

# 3. マイグレーション適用
supabase db push

# 4. 確認
supabase db diff  # 差分確認
```

## マイグレーション作成ガイドライン

### 1. 基本原則

- **破壊的変更の禁止**: 既存データを失う変更は避ける
- **段階的移行**: 大きな変更は複数のマイグレーションに分割
- **ロールバック可能性**: 可能な限りロールバック手順を用意
- **パフォーマンス考慮**: インデックス作成は適切なタイミングで実行

### 2. 推奨パターン

#### テーブル作成
```sql
-- 新しいテーブル作成
CREATE TABLE table_name (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- インデックス作成
CREATE INDEX idx_table_name_created_at ON table_name(created_at);
```

#### カラム追加
```sql
-- NOT NULL制約のないカラム追加
ALTER TABLE table_name ADD COLUMN new_column VARCHAR(255);

-- NOT NULL制約が必要な場合は段階的に
-- 1. カラム追加（NULL許可）
ALTER TABLE table_name ADD COLUMN new_column VARCHAR(255);

-- 2. デフォルト値設定
UPDATE table_name SET new_column = 'default_value' WHERE new_column IS NULL;

-- 3. NOT NULL制約追加
ALTER TABLE table_name ALTER COLUMN new_column SET NOT NULL;
```

#### カラム削除（非推奨）
```sql
-- まずアプリケーション側でカラム使用を停止
-- その後、マイグレーションで削除
ALTER TABLE table_name DROP COLUMN old_column;
```

### 3. 禁止事項

- **直接的なDROP TABLE**: 本番データ消失のリスク
- **大量データのUPDATE**: パフォーマンス問題
- **外部キー制約の即座な追加**: 既存データとの整合性問題
