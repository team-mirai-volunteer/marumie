# 新規参加者向けSupabaseセットアップガイド

## 前提条件

- Docker Desktopがインストール済み
- Node.js (18以上) がインストール済み
- プロジェクトをクローン済み

## セットアップ手順

### 1. 依存関係インストール

```bash
npm install
```

### 2. Docker Desktop起動確認

```bash
# Docker が起動しているか確認
docker --version
docker ps
```

### 3. Supabaseローカル環境起動

```bash
# Supabaseエミュレーター起動
npx supabase start
```

**起動に時間がかかります（初回は数分）。完了すると以下が表示されます：**

```
Started supabase local development setup.

         API URL: http://127.0.0.1:54321
     GraphQL URL: http://127.0.0.1:54321/graphql/v1
          DB URL: postgresql://postgres:postgres@127.0.0.1:54332/postgres
      Studio URL: http://127.0.0.1:54323
```

### 4. テーブル作成確認

#### 4-1. Studio でテーブル確認

1. ブラウザで http://127.0.0.1:54323 にアクセス
2. 左側サイドバーの「Tables」をクリック
3. `political_organizations` と `transactions` テーブルが表示されることを確認

#### 4-2. テーブルが表示されない場合

**手動でテーブルを作成してください：**

```bash
# 政治団体テーブル作成
docker exec supabase_db_poli-money-something psql -U postgres -d postgres -c "
CREATE TABLE IF NOT EXISTS political_organizations (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);"

# 取引テーブル作成
docker exec supabase_db_poli-money-something psql -U postgres -d postgres -c "
CREATE TABLE IF NOT EXISTS transactions (
    id BIGSERIAL PRIMARY KEY,
    political_organization_id BIGINT NOT NULL REFERENCES political_organizations(id),
    transaction_no VARCHAR(255) UNIQUE,
    transaction_date DATE NOT NULL,
    financial_year INTEGER NOT NULL,
    transaction_type VARCHAR(20) NOT NULL CHECK (transaction_type IN ('income', 'expense', 'other')),
    debit_account VARCHAR(255) NOT NULL,
    debit_sub_account VARCHAR(255),
    debit_department VARCHAR(255),
    debit_partner VARCHAR(255),
    debit_tax_category VARCHAR(255),
    debit_amount DECIMAL(15,2) NOT NULL,
    credit_account VARCHAR(255) NOT NULL,
    credit_sub_account VARCHAR(255),
    credit_department VARCHAR(255),
    credit_partner VARCHAR(255),
    credit_tax_category VARCHAR(255),
    credit_amount DECIMAL(15,2) NOT NULL,
    description TEXT,
    description_1 TEXT,
    description_2 TEXT,
    description_3 TEXT,
    description_detail TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);"

# インデックス作成
docker exec supabase_db_poli-money-something psql -U postgres -d postgres -c "
CREATE INDEX IF NOT EXISTS idx_transactions_political_organization_id ON transactions(political_organization_id);
CREATE INDEX IF NOT EXISTS idx_transactions_transaction_date ON transactions(transaction_date);
CREATE INDEX IF NOT EXISTS idx_transactions_financial_year ON transactions(financial_year);
CREATE INDEX IF NOT EXISTS idx_transactions_transaction_type ON transactions(transaction_type);"
```

#### 4-3. 作成確認

```bash
# テーブルが正しく作成されたかチェック
docker exec supabase_db_poli-money-something psql -U postgres -d postgres -c "\dt"
```

以下が表示されればOK：
```
                  List of relations
 Schema |          Name           | Type  |  Owner   
--------+-------------------------+-------+----------
 public | political_organizations | table | postgres
 public | transactions            | table | postgres
```

### 5. 型定義生成

```bash
# TypeScript型定義ファイル生成
npx supabase gen types typescript --local > supabase/types.gen.ts
```

### 6. 環境変数設定（任意）

ローカル開発では不要ですが、明示的に設定したい場合：

`.env.local` ファイルを作成：
```env
# Supabase Local
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54332/postgres
```

## トラブルシューティング

### Docker関連エラー

#### `Cannot connect to the Docker daemon`
```bash
# Docker Desktopが起動していない
# → Docker Desktopアプリケーションを起動してください
```

#### `port is already allocated`
```bash
# 他のSupabaseインスタンスが起動している
npx supabase stop
npx supabase start
```

### マイグレーション関連エラー

#### `ERROR: invalid byte sequence for encoding "UTF8"`
- マイグレーションファイルに日本語コメントが含まれている
- 手動テーブル作成コマンド（上記4-2）を実行

#### `Cannot find project ref`
- ローカル環境では `supabase link` は不要
- `npx supabase start` が正常に動作していれば問題なし

### Studio関連

#### テーブルが表示されない
1. ブラウザリフレッシュ（Cmd+R / Ctrl+R）
2. ブラウザキャッシュクリア
3. 手動テーブル作成（上記4-2）実行

## よく使うコマンド

```bash
# Supabase状態確認
npx supabase status

# Supabase停止
npx supabase stop

# データベースリセット
npx supabase db reset

# 型定義再生成
npx supabase gen types typescript --local > supabase/types.gen.ts

# ログ確認
npx supabase logs

# テーブル確認
docker exec supabase_db_poli-money-something psql -U postgres -d postgres -c "\dt"
```

## セットアップ完了チェックリスト

- [ ] `npx supabase status` が正常な出力を返す
- [ ] Studio (http://127.0.0.1:54323) でテーブル確認できる
- [ ] `political_organizations` テーブルが存在
- [ ] `transactions` テーブルが存在
- [ ] `supabase/types.gen.ts` ファイルが生成されている

## 困った時の連絡先

セットアップで問題が発生した場合は、以下の情報と一緒に相談してください：

1. 実行したコマンド
2. エラーメッセージの全文
3. `npx supabase status` の出力
4. OS・環境情報